name: Publish to PyPI

on:
  push:
    branches:
      - main

jobs:
  build-and-publish:
    name: Build and Publish to PyPI
    runs-on: ubuntu-latest
    environment: Deploy
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Upgrade pip, build, and twine
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Verify package configuration
        run: |
          if [ ! -f "pyproject.toml" ]; then
            echo "Error: pyproject.toml not found"
            exit 1
          fi
          if [ ! -f "setup.py" ]; then
            echo "Error: setup.py not found"
            exit 1
          fi
          echo "Package configuration files verified"

      - name: Build package
        run: |
          python -m build
          ls -lah dist/

      - name: Check package with twine
        run: |
          python -m twine check dist/*

      - name: Verify build artifacts
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist/*.whl dist/*.tar.gz 2>/dev/null)" ]; then
            echo "Error: No distribution files found in dist/"
            exit 1
          fi
          echo "Build artifacts verified:"
          ls -lh dist/

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_KEY }}
        run: |
          if [ -z "$TWINE_PASSWORD" ]; then
            echo "Error: PYPI_API_KEY secret is not set"
            exit 1
          fi
          python -m twine upload dist/* --verbose
        continue-on-error: false

      - name: Cleanup build artifacts
        if: always()
        run: |
          rm -rf dist/ build/ *.egg-info/
          echo "Build artifacts cleaned up"

